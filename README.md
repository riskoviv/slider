# Slider jQuery-плагин
[![readme in english](https://img.shields.io/badge/lang-en-green)](README.en.md)

Кастомизируемый **jQuery**-плагин, реализующий функционал бегунка (слайдера). Написан на TypeScript с использованием архитектуры **MVP** и SCSS c использованием CSS custom properties.

## Совместимость с nodejs и jQuery
Для работы с исходным кодом проекта и успешной сборки необходим nodejs версии не ниже 12.

Для использования готового плагина, к странице, использующей плагин, должна быть подключена библиотека jQuery версии не ниже 3.2.0.

## npm-скрипты в package.json
В проекте есть несколько скриптов, упрощающих разработку и тестирование кода. Каждый скрипт запускается через консоль, при этом текущий путь в консоли должен быть корнем проекта.

Скрипты запускаются следующим образом: `npm <имя скрипта>` или `npm run <имя скрипта>`, например: `npm start`.

Имеющиеся скрипты:

Имя скрипта | Предназначение
--- | ---
start | Запуск webpack dev server. Проект собирается в режиме development и демо-страница (файл dist/demo/demo-page.html) открывается с локального сервера в браузере по умолчанию. При этом отслеживаются изменения в файлах проекта, которые включаются в финальную сборку и при изменении какого-то из этих файлов происходит быстрая пересборка проекта и демо-страница, открытая в браузере, обновляется.
test | Запуск всех тестов проекта. По сути это просто запуск команды `jest` без опций. Опционально после этой команды через пробел можно указать, какой именно файл / файлы тестов нужно запустить. _Более подробно об этом можно прочитать в [документации фреймворка Jest](https://jestjs.io/docs/cli)._
dev | Сборка проекта в режиме development. Предназначен для промежуточной компиляции в процессе разработки. Быстрая сборка без минификации кода и с добавлением source map (карты кода) для возможности просмотра в Devtools браузера исходного кода на TypeScript, и в случае ошибки или предупреждения, местоположения в коде, где это произошло. Результат сборки будет сохранён в папку dist, при этом всё предыдущее содержимое папки будет удалено.
build | Сборка проекта в режиме production. Предназначен для получения файлов, готовых к публикации. Выполняется с минификацией всего кода и без добавления source map, также удаляются все выводы console.warn и console.error. Результат сборки будет сохранён в папку dist, при этом всё предыдущее содержимое папки будет удалено.

## Тестирование плагина
Тесты плагина написаны с использованием фреймворка Jest и немного DOM testing library.

Для запуска всех тестов достаточно выполнить в консоли команду `npm test`

Для запуска тестов из определённого файла нужно добавить к `npm test` имя или часть имени файла или нескольких файлов с тестами. В результате будут запущены все файлы тестов, имена которых полностью или частично состоят из указанных строк.

Например, для запуска тестов только класса Model нужно выполнить команду `npm test model`

## Архитектура плагина
Плагин полностью написан на языке TypeScript с использованием шаблона MVP с passive view.

Основные архитектурные составляющие это Model, Presenter, View и subViews.

### Классовая структура
Model и Presenter создаются в функции-инициализаторе плагина, Model передается в Presenter, View и subViews создаются внутри Presenter'а. Model, View и все subView ничего не знают ни друг о друге, ни о Presenter'е, и могут использовать только свои и унаследованные свойства и методы и могут работать автономно.

Model и View наследуются от абстрактного класса EventEmitter, все subView наследуются от абстрактного класса SubView, который тоже наследуется от EventEmitter.

Presenter знает о Model, View и каждом subView, и может со всеми ими взаимодействовать. Presenter ни от чего не наследуется, он не может работать без Model, View и классов subView.

Logger – это класс, используемый в режиме разработки классами Model, EventEmitter и функцией инициализации плагина для продвинутого вывода и сохранения сообщений об ошибках и предупреждений, возникающих при инициализации плагина и во время его работы

Panel – это класс для демонстрации динамической кастомизации плагина на демо-странице. Он принимает в себя при инициализации экземпляр плагина, получает его опции и создаёт на странице свои элементы со значениями в зависимости от настроек полученного плагина. Также он подписывается на все события плагина и создаёт обработчики для всех своих элементов для передачи их значений в плагин.

### UML-диаграмма классовой структуры плагина

![UML class diagram](./class-diagram.drawio.svg)

### Устройство механизма внутренней подписки на события и оповещения о них
Presenter может обращаться ко всем публичным свойствам и методам остальных классов, включая метод `on` (унаследованный от класса EventEmitter), который позволяет ему подписываться на события этих классов.

При вызове этого метода передаются 2 аргумента: название события, на которое выполняется подписка и функция, которая будет вызвана при срабатывании события.

Все классы, генерирующие события, могут оповещать подписчика (Presenter) о произошедшем событии вызовом своего метода `emit` (унаследован от класса EventEmitter). В метод emit передаются новые данные (новое значение изменённой опции или данные от DOM-события), которые затем передаются как аргумент (число, булево значение или объект) в функцию-подписчик от Presenter'а.

Model, View и subViews могут передавать данные только в Presenter и только через метод `emit`.

Presenter может передавать данные в остальные классы как прямой записью в их публичные свойства, так и при вызове их публичных методов.

### Последовательность действий, выполняемых в плагине при инициализации
Функция, инициализирующая плагин (`sliderPlugin`), проверяет переданный в него аргумент-объект со значениями кастомных опций и если какие-то из опций некорректны, они игнорируются и для этих опций используются значения по умолчанию.

В этой же функции создаётся Model, в которую передаётся готовый объект с опциями для дальнейшей проверки и сохранения в опциях модели.

Затем создаётся Presenter, в его конструктор передаются 2 аргумента: jQuery-элемент, на котором был вызван метод инициализации плагина, и только что созданная Model.

Внутри Presenter'а происходит создание View и всех subView, нужных в первоначальном состоянии слайдера (в зависимости от опций). Также Presenter подписывается на все возможные события Model, View и subView. Затем Presenter вызовом публичных методов передаёт во View начальные значения тех опций состояния, в случае включённости которых нужно добавлять классы-модификаторы на корневой элемент слайдера для задания подходящих стилей. Также Presenter инициализирует ResizeObserver для обновления элемента шкалы в случае, если нужно отображать на ней меньше или больше кликабельных элементов, и для возможного слияния / разъединения плавающих подсказок.

После инициализации Presenter'а на корневой элемент слайдера, созданный внутри View, добавляются публичные методы для динамической кастомизации слайдера, используя их можно изменить любую из [опций](#api-плагина) плагина. Также добавляются методы для подписывания / отписывания на события слайдера других HTML-элементов страницы или callback-функций.

Метод инициализации плагина `slider-plugin` в итоге возвращает JQuery\<HTMLElement>, с которым можно взаимодействовать, вызывая на нём методы для изменения опций или подписки / отписки.

События, на которые может реагировать View – это DOM-события:
- **pointerdown** (с возможным далее **pointermove**) на элементе `div.slider__control-container`, при этом объектом Event.target при pointerdown может быть как сам control-container, так и бегунок (`div.slider__thumb_1` или `_2`)
- **pointerdown** на элементах `span.slider__scale-text`

События, генерируемые внутри Model, могут вызываться всеми публичными методами кастомизации плагина, если в них передаются валидные значения.

Presenter реагирует на все события от Model и subView.

При событии, вызванном subView, Presenter обрабатывает полученные при этом от subView данные и выполняет все необходимые действия и записывает изменения в опциях в Model.

Model перед отправкой события проверяет поступившие данные и записывает в опции, и только тогда вызывает событие, которое отлавливает Presenter и передаёт изменённые значения во View для отображения изменений на слайдере.

## Подписка на события плагина
Плагин позволяет подписываться на его события, происходящие при изменении опций. Каждое событие связано с каким-то одним значением опций.

Для подписки на событие нужно вызвать метод `subscribe` на элементе плагина, возвращённом функцией инициализации `sliderPlugin`. Метод subscribe принимает 2 аргумента:
1. [Название события](#api-плагина)
2. Подписчик. Это может быть:
   1. При подписке на событие изменения **числового значения** – элемент `<input type="number">` или функция, принимающая 1 аргумент типа **number**
   2. При подписке на событие изменения **состояния** – элемент `<input type="checkbox">` или функция, принимающая 1 аргумент типа **boolean**

Пример подписки HTML-элемента `<input type="number">` на событие изменения значения:
```js
// здесь используется виртуальный элемент,
// но точно так же может быть использован и элемент, находящийся на странице
const inputNumberElement = document.createElement('input');
inputNumberElement.type = 'number';
const slider2 = $('#slider2').sliderPlugin();
slider2.subscribe('value2Changed', inputNumberElement);
// теперь при срабатывании события value2Changed на слайдере slider2
// значение, содержащееся в этом элементе будет заменено на новое значение value2 слайдера
```
Пример подписки HTML-элемента `<input type="checkbox">` на событие изменения состояния:
```js
const inputCheckboxElement = document.querySelector('input[type="checkbox"]');
const slider3 = $('#slider3').sliderPlugin();
slider3.subscribe('isIntervalChanged', inputCheckboxElement);
```
Пример подписки функции на событие плагина:
```js
// сохраняем экземпляр плагина в переменную slider1
const slider1 = $('#slider1').sliderPlugin();
let changeableValue;

// чтобы потом была возможность отписать эту функцию от события,
// нужно её заранее сохранить в переменную (numberCallback в данном случае)
const numberCallback = (value1) => { changeableValue = value1 };

// значение переменной changeableValue будет меняться на новое значение value1
// в callback-функции при срабатывании события value1Changed
slider1.subscribe('value1Changed', numberCallback);
```

### ⚠ Замечание о подписке элемента, использующего API
Если подписываемый HTML-элемент будет использоваться ещё и как элемент, значение которого будет менять какое-то значение в плагине *(передаваться при событии input/change функцией-обработчиком в API-метод плагина, как в случае с инпутами в панелях на демо-странице)*, может происходить лишний вызов API-метода плагина с передачей в него уже и так только что изменённого значения.

Однако это не очень большая проблема, т.к. внутри плагина есть проверка каждого значения, приходящего в него извне, и если это значение не отличается от текущего, оно не будет перезаписывать текущее, не будет возвращено подписчикам и на подписчике не будет вызвано событие input/change; зацикливания возвращения значения из плагина и записи в плагин не происходит.

Но всё же рекомендуется предотвращать это проверкой свойства `isSubscribeSet` на объекте события. Например:

```typescript
const sliderPlugin5 = $('#slider5').sliderPlugin();
// дополняем интерфейс события свойством isSubscribeSet,
// чтобы проверить его значение в обработчике
interface SubscribeSetEvent extends Event {
  isSubscribeSet?: boolean;
}
const minInputListener = (e: SubscribeSetEvent) => {
  // передавать новое значение инпута в плагин только если
  // изменение значения в инпуте вызвано не самим плагином, а каким-то другим способом
  if (!e.isSubscribeSet) {
    sliderPlugin5.setMinValue(e.target.valueAsNumber));
  }
}
const minValueInput = document.querySelector('.panel__input[data-role="min"]');
// инпут при изменении своего значения будет изменять minValue плагина
minValueInput.addEventListener('input', minInputListener);
// и при этом будет подписчиком значения minValue плагина
sliderPlugin5.subscribe('minValueChanged', minValueInput);
```

## Отписка от событий плагина
Подписанные функции и HTML-элементы можно отписать от событий, на которые они были ранее подписаны. Это можно сделать двумя способами:
1. Передать ранее подписанный элемент / функцию в метод `unsubscribe` плагина:
   ```js
   slider1.unsubscribe(numberCallback);
   ```
2. Вызвать метод unsubscribe на самом подписанном HTML-элементе или функции:
   ```js
   inputNumberElement.unsubscribe();
   ```
*Каждый подписчик может быть подписан только на одно событие и при использовании любого из двух способов отписки элемент или функция будет найдена в хранилище подписчиков, поэтому при отписке не нужно уточнять, от какого события его нужно отписать.*

## Использование плагина
- К HTML-странице, на которой вы хотите использовать плагин, подключите файл библиотеки jQuery. Например, прописав в секции `<head>` следующее:

  ```html
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  ```
- Там же подключите к вашей странице файл скрипта плагина `slider-plugin.js`, используя тег `script`:
  ```html
  <script defer src="./slider-plugin.js"></script>
  ```
  и его стили `slider-plugin.css`, используя тег `link`:
  ```html
  <link href="./slider-plugin.css" rel="stylesheet">
  ```
- Плагин создаётся на объекте типа `JQuery<HTMLElement>` путём вызова метода `sliderPlugin()` на этом элементе.

  Создать плагин со [**стандартными** опциями](#api-плагина) можно, если вызвать метод инициализации плагина без аргументов:
  ```js
  $('#slider').sliderPlugin();
  ```
  Где `#slider` – это селектор вашего элемента на странице, внутри которого будет размещён слайдер. ⚠ При этом всё содержимое этого элемента, если оно имеется, будет полностью удалено.
- Начальное состояние плагина можно кастомизировать своими значениями опций.
  Для этого нужно передать объект с опциями как аргумент в метод инициализации плагина:
  ```js
  $('#slider').sliderPlugin({ isVertical: true, stepSize: 5 });
  ```
  Для опций, отсутствующих в переданном объекте, будут использованы значения по умолчанию.

## API плагина
**Опции** – это свойства объекта, принимаемого как единственный аргумент функцией инициализации плагина. Есть 2 вида опций: опции состояния, которые хранят значения типа boolean, и числовые опции, которые хранят значения типа number.

Также есть возможность вызывать методы на экземпляре созданного плагина, возвращаемого функцией инициализации, которые могут менять значения всех опций плагина. Все методы описаны в последних столбцах нижеприведённых таблиц. Каждый метод принимает один аргумент типа boolean или number, в зависимости от типа опции, которую он меняет (методы, меняющие опции состояния, принимают аргумент типа boolean; методы, меняющие числовые опции, принимают аргумент типа number).

### Примеры использования API-методов
```js
const slider6 = $('#slider6').sliderPlugin();
// изменение maxValue на 30
slider6.setMaxValue(30);
// включение шкалы
slider6.setShowScale(true);
// можно также сцеплять методы в неограниченном количестве
// в этом примере включается вертикальный режим и изменяется minValue на 0
slider6.setVerticalState(true).setMinValue(0);
```

### Опции, события и методы значений состояния
Принимают значение типа `boolean`, по умолчанию все имеют значение `false`

Опция | Описание | Событие, происходящее при изменении этой опции | API-метод, меняющий эту опцию
--- | --- | --- | ---
`isVertical` | горизонтальный / вертикальный вид | `isVerticalChanged` | `setVerticalState`
`isInterval` | одиночное значение (1 бегунок) / интервал (2 бегунка) | `isIntervalChanged` | `setInterval`
`showTip` | показывать ли плавающую подсказку над бегунком (или бегунками, если их 2) | `showTipChanged` | `setShowTip`
`showScale` | показывать ли под слайдером шкалу с допустимыми значениями с учётом шага | `showScaleChanged` | `setShowScale`
`showProgressBar` | показывать ли прогресс бар: при одиночном значении от начала слайдера до бегунка, при интервале от первого до второго бегунка  | `showProgressChanged` | `setShowProgress`

### Опции, события и методы числовых значений
Принимают значение типа `number`, по умолчанию у всех опций своё значение

Опция | Значение по умолчанию | Описание | Событие, происходящее при изменении этой опции | API-метод, меняющий эту опцию
--- | --- | --- | --- | ---
`stepSize` | 10 | размер шага, на который могут перемещаться бегунки начиная с минимального значения | `stepSizeChanged` | `setStepSize`
`minValue` | -100 | минимальное значение слайдера | `minValueChanged` | `setMinValue`
`maxValue` | 100 | максимальное значение слайдера | `maxValueChanged` | `setMaxValue`
`value1` | -50 | первое значение, на него указывает первый бегунок | `value1Changed` | `setValue1`
`value2` | 50 | второе значение, на него указывает второй бегунок | `value2Changed` | `setValue2`


### Другие методы
Имя метода | Описание
--- | ---
`getOptions` | Не принимает аргументов, возвращает объект опций плагина со значениями **на момент вызова метода**. ⚠ При последующей смене опций плагина значения в полученном объекте могут быть не актуальны.
